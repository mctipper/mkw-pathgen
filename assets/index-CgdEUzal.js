(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();function P(e,t){requestAnimationFrame(()=>{const o=t.getBoundingClientRect();e.style.width=`${o.width}px`,e.style.height=`${o.height}px`,e.style.left=`${o.left+window.scrollX}px`})}function j(e,t){requestAnimationFrame(()=>{const o=t.getBoundingClientRect();e.style.width=`${o.width}px`})}async function O(){const[e,t]=await Promise.all([fetch("/mkw-pathgen//data/tracks.json"),fetch("/mkw-pathgen//data/adjacency.json")]);if(!e.ok)throw new Error("Failed to load tracks.json data");if(!t.ok)throw new Error("Failed to load adjacency.json data");const o=await e.json(),s=await t.json(),n={};for(const[r,c]of Object.entries(o))n[r]={id:r,...c,parents:[],children:[]};for(const[r,c]of Object.entries(s)){n[r].children=c;for(const a of c)n[a].parents.push(r)}return n}let y=null;async function B(e){y||(y=await O(),e.textContent=JSON.stringify(y))}function v(){if(!y)throw new Error("TrackMap not yet initialised. Call initTrackMapStore() first.");return y}function I(){const e=document.querySelector("#selected-track-store");if(!e)throw new Error("SelectedTrackStore: #selected-track-store element not found");return e}function F(e){let t=I();t.textContent=e?JSON.stringify(e):""}function H(){const t=I().textContent;if(!t)return null;try{return JSON.parse(t)}catch{return console.warn("SelectedTrackStore: Failed to parse stored track JSON"),null}}function N(){return Array.from(document.querySelectorAll(".track-icon"))}const R=(()=>{const e=document.querySelector(".generate-button");if(!e)throw new Error("Generate button not found");return e})();function q(){R.disabled=!0}function G(){R.disabled=!1}let x=0;function D(e){N().forEach(o=>{o.classList.remove("path")}),e.forEach(o=>{const s=document.getElementById(o);s&&!s.classList.contains("path")&&s.classList.add("path")})}function L(){A([])}async function A(e){const t=++x,o=document.querySelector(".path-lines-layer");if(!o)return;const s=document.querySelector(".base-map");if(!s)return;o.innerHTML="",D(e);const n=l=>{const d=l.getBoundingClientRect(),i=o.getBoundingClientRect();return[d.left+d.width/2-i.left,d.top+d.height/2-i.top]},r=()=>t!==x,c=async(l,d,i,u,p,m,g)=>{if(r())return;const f=document.createElementNS("http://www.w3.org/2000/svg","path"),w=`M ${l} ${d} L ${i} ${u}`;f.setAttribute("d",w),f.setAttribute("stroke",p),f.setAttribute("stroke-width",m),f.setAttribute("fill","none"),f.setAttribute("stroke-linecap","round"),g&&f.setAttribute("stroke-dasharray",g);const h=f.getTotalLength();return f.setAttribute("stroke-dasharray",g??h.toString()),f.setAttribute("stroke-dashoffset",h.toString()),o.appendChild(f),f.animate([{strokeDashoffset:h},{strokeDashoffset:0}],{duration:500,easing:"ease-out",fill:"forwards"}).finished},a=async(l,d)=>{if(r())return;const i=s.height/15,u=(h,S,b,C)=>{const k=document.createElementNS("http://www.w3.org/2000/svg","circle");return k.setAttribute("cx",l.toString()),k.setAttribute("cy",d.toString()),k.setAttribute("r",i.toString()),k.setAttribute("stroke",h),k.setAttribute("stroke-width",S.toString()),k.setAttribute("fill","none"),b&&k.setAttribute("stroke-dasharray",b),C!==void 0&&(k.style.opacity=C.toString()),k},p=async h=>{const S=2*Math.PI*i;return h.setAttribute("stroke-dasharray",S.toString()),h.setAttribute("stroke-dashoffset",S.toString()),o.appendChild(h),h.animate([{strokeDashoffset:S},{strokeDashoffset:0}],{duration:500,easing:"ease-out",fill:"forwards"}).finished},m=async h=>r()?void 0:(o.appendChild(h),h.animate([{opacity:0},{opacity:1}],{duration:500,easing:"ease-out",fill:"forwards"}).finished),g=u("black",16),f=u("white",10),w=u("black",2,"6,4",0);await Promise.all([p(g),p(f)]),await m(w)};for(let l=0;l<e.length-1;l++){if(r())return;const d=document.getElementById(e[l]),i=document.getElementById(e[l+1]);if(!d||!i)continue;const[u,p]=n(d),[m,g]=n(i);e[l]===e[l+1]?await a(u,p):(await Promise.all([c(u,p,m,g,"black","16"),c(u,p,m,g,"white","10")]),await c(u,p,m,g,"black","2","6,4"))}}function _(e,t,o){const s=N(),n=!!t;o.innerHTML=n?`< ${t.names.en_gb} >`:"Select a track!",o.classList.toggle("track-selected-title-text",n),F(t),L(),n?G():q(),s.forEach(r=>{r===e&&n?(r.classList.add("iconSelected"),r.classList.remove("iconNotSelected")):(r.classList.remove("iconSelected"),r.classList.toggle("iconNotSelected",n))})}function E(){const e=document.querySelector(".path-results-text");e&&(e.innerHTML="")}function J(e){E();const t=document.querySelector(".path-results-text");if(!t)return;e.length===0&&(t.innerHTML="No Path Found from Selected Track");const o=v(),s=document.createElement("ul");s.className="path-results-list";const n=document.createElement("span");n.innerHTML=">>>";for(let r=1;r<e.length;r++){const c=e[r-1],a=e[r],l=document.createElement("li");if(c===a){l.className="path-list-item single-track-row";const d=document.createElement("span");d.className="single-track-text",d.textContent=`${o[a].names.en_gb} (3 laps)`,l.appendChild(d)}else{l.className="path-list-item";const d=document.createElement("span");d.className="track-left",d.textContent=o[c].names.en_gb;const i=document.createElement("span");i.className="track-arrow",i.textContent=">>>";const u=document.createElement("span");u.className="track-right",u.textContent=o[a].names.en_gb,l.appendChild(d),l.appendChild(i),l.appendChild(u)}s.appendChild(l)}t.appendChild(s)}function z(e,t,o,s){L(),E(),o&&o!==e&&o.classList.remove("iconSelected");const n=e.classList.toggle("iconSelected"),r=n?e:null,c=n?t:null;return _(e,c,s),{newSelectedIcon:r,newSelectedTrack:c}}function K(e,t){const o=t.offsetWidth/t.naturalWidth,s=t.offsetHeight/t.naturalHeight;e.innerHTML="";const n=t.height/8,r=n/2,c=document.querySelector(".selected-track-text");let a=null;const l=v();L(),E();for(const d of Object.values(l)){const i=document.createElement("img");i.className="track-icon",i.id=d.id,i.src=`/mkw-pathgen/images/track-icons/${d.icon}`,i.alt=d.names.en_gb,i.style.position="absolute",i.style.width=`${n}px`,i.style.height=`${n}px`,i.style.left=`${d.coords.X*o-r}px`,i.style.top=`${d.coords.Y*s-r}px`,i.addEventListener("click",()=>{a=z(i,d,a,c).newSelectedIcon}),e.appendChild(i)}}function M(e){const t=[...e];for(let o=0;o<3;o++)for(let s=t.length-1;s>0;s--){const n=Math.floor(Math.random()*(s+1));[t[s],t[n]]=[t[n],t[s]]}return t}function T(e,t,o,s,n=!1,r=!1){const c=[],a=new Set,l=new Set,d=i=>{if(c.length>=s)return;c.push(i);const u=e[i];if(!u)return;const p=n?[...u.children,u.id]:u.children,m=n?[...u.parents,u.id]:u.parents,g=M(o==="forward"?p:m);console.debug(i,g);for(const f of g){if(c.length>=s)break;if(c.length>=2&&c[c.length-2]===f||!r&&a.has(f))continue;const w=`${i}->${f}`;l.has(w)||(a.add(f),l.add(w),d(f))}};return d(t),c.slice(0,s)}function V(e,t,o){let a=T(e,t,o?"backward":"forward",4,!1,!1);return console.debug(`First: ${a}`),o&&(a=a.reverse()),a.unshift(a[0]),console.debug(`Second: ${a}`),a.length<5?[]:a}function X(e,t,o){const s=o?"backward":"forward",n=6;let a=T(e,t,s,n,!1,!1);return console.debug(`First: ${a}`),o&&(a=a.reverse()),console.debug(`Second: ${a}`),a.length<n?[]:a}function W(e,t,o,s,n){const r=s?"backward":"forward",c=o+1;let l=T(e,t,r,c,n,!0);return console.debug(`First: ${l}`),s&&(l=l.reverse()),console.debug(`Second: ${l}`),l.length<c?[]:l}function Y(e,t,o){const s=H();if(!s){console.log("No track selected");return}const n=v();console.log("Selected track:",s.names.en_gb),console.log("Selected path mode:",e.value),console.log('Selected "end with":',t.checked),console.log("Selected include single-track:",o.checked);const r=(()=>{const c=e.value;if(c==="gp")return V(n,s.id,t.checked);if(c==="kt")return X(n,s.id,t.checked);if(c.startsWith("vs")){const a=Number(c.replace("vs",""));return W(n,s.id,a,t.checked,o.checked)}return["How did you get here"]})();console.log(r),J(r),A(r)}function $(e,t){const o=e.startsWith("vs");t.disabled=!o,o||(t.checked=!1)}async function Q(){const e={trackMapStore:document.querySelector("#track-map-store"),selectedTrackStore:document.querySelector("#selected-track-store"),trackIconLayer:document.querySelector(".track-icons-layer"),mapImg:document.querySelector(".base-map"),pathGenControls:document.querySelector(".map-controls"),generateButton:document.querySelector(".generate-button"),pathModeSelect:document.querySelector(".path-options-dropdown"),selectedTrackEndCheck:document.querySelector(".selected-track-end"),includeSingleTrackCheck:document.querySelector(".include-single-track")},t=Object.entries(e).filter(([,u])=>u===null).map(([u])=>u);if(t.length>0){const u=t.length>1?"s":"";console.error(`Missing required DOM element${u}: ${t.join(", ")}`);return}const{trackMapStore:o,trackIconLayer:s,mapImg:n,pathGenControls:r,generateButton:c,pathModeSelect:a,selectedTrackEndCheck:l,includeSingleTrackCheck:d}=e;await B(o),q(),c.addEventListener("click",()=>Y(a,l,d)),$(a.value,d),a.addEventListener("change",()=>$(a.value,d));function i(){P(s,n),j(r,n),K(s,n)}n.complete?i():n.addEventListener("load",i),window.addEventListener("resize",i)}Q();
