(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();function x(){return Array.from(document.querySelectorAll(".track-icon"))}async function F(){const[t,e]=await Promise.all([fetch("/mkw-pathgen//data/tracks.json"),fetch("/mkw-pathgen//data/adjacency.json")]);if(!t.ok)throw new Error("Failed to load tracks.json data");if(!e.ok)throw new Error("Failed to load adjacency.json data");const o=await t.json(),r=await e.json(),n={};for(const[s,a]of Object.entries(o))n[s]={id:s,...a,parents:[],children:[]};for(const[s,a]of Object.entries(r)){n[s].children=a;for(const l of a)n[l].parents.push(s)}return n}let T=null;async function G(){T||(T=await F())}function $(){if(!T)throw new Error("TrackMap not yet initialised. Call initTrackMapStore() first.");return T}let I=null;function z(t){I=t}function D(){return I}const P=(()=>{const t=document.querySelector(".generate-button");if(!t)throw new Error("Generate button not found");return t})();function q(){P.disabled=!0}function K(){P.disabled=!1}let M=0;function X(t){x().forEach(o=>{o.classList.remove("path")}),t.forEach(o=>{const r=document.getElementById(o);r&&!r.classList.contains("path")&&r.classList.add("path")})}function B(){H([])}async function H(t){const e=++M,o=document.querySelector(".path-lines-layer");if(!o)return;const r=document.querySelector(".base-map");if(!r)return;o.innerHTML="",X(t);const n=c=>{const i=c.getBoundingClientRect(),g=o.getBoundingClientRect();return[i.left+i.width/2-g.left,i.top+i.height/2-g.top]},s=()=>e!==M,a=async(c,i)=>{const f=c.getAttribute("stroke-dasharray")??i.toString();return c.setAttribute("stroke-dasharray",f),c.setAttribute("stroke-dashoffset",f),o.appendChild(c),c.animate([{strokeDashoffset:parseFloat(f)},{strokeDashoffset:0}],{duration:500,easing:"ease-out",fill:"forwards"}).finished},l=(c,i,g,f,w,y,d)=>{if(s())return;const u=document.createElementNS("http://www.w3.org/2000/svg","path");u.setAttribute("d",`M ${c} ${i} L ${g} ${f}`),u.setAttribute("stroke",w),u.setAttribute("stroke-width",y),u.setAttribute("opacity",d),u.setAttribute("fill","none"),u.setAttribute("stroke-linecap","round"),o.appendChild(u)},h=(c,i,g,f,w,y,d)=>{const u=document.createElementNS("http://www.w3.org/2000/svg","path");return u.setAttribute("d",`M ${c} ${i} L ${g} ${f}`),u.setAttribute("stroke",w),u.setAttribute("stroke-width",y),u.setAttribute("fill","none"),u.setAttribute("stroke-linecap","round"),d&&u.setAttribute("stroke-dasharray",d),u},p=(c,i,g,f,w)=>{const y=r.height/15,d=document.createElementNS("http://www.w3.org/2000/svg","circle");return d.setAttribute("cx",c.toString()),d.setAttribute("cy",i.toString()),d.setAttribute("r",y.toString()),d.setAttribute("stroke",g),d.setAttribute("stroke-width",f.toString()),d.setAttribute("fill","none"),w&&d.setAttribute("stroke-dasharray",w),d},m="0.8";for(let c=0;c<t.length-1;c++){if(s())return;const i=document.getElementById(t[c]),g=document.getElementById(t[c+1]);if(!i||!g)continue;const[f,w]=n(i),[y,d]=n(g);if(t[c]===t[c+1]){const u=r.height/15,k=document.createElementNS("http://www.w3.org/2000/svg","circle");k.setAttribute("cx",f.toString()),k.setAttribute("cy",w.toString()),k.setAttribute("r",u.toString()),k.setAttribute("stroke","black"),k.setAttribute("stroke-width","16"),k.setAttribute("fill","none"),k.setAttribute("opacity",m),o.appendChild(k)}else l(f,w,y,d,"black","16",m)}for(let c=0;c<t.length-1;c++){if(s())return;const i=document.getElementById(t[c]),g=document.getElementById(t[c+1]);if(!i||!g)continue;const[f,w]=n(i),[y,d]=n(g);if(t[c]===t[c+1]){const u=p(f,w,"white",10),k=p(f,w,"black",2,"6,4"),b=r.height/15,R=2*Math.PI*b;await Promise.all([a(u,R),a(k,R)])}else{const u=h(f,w,y,d,"white","10"),k=h(f,w,y,d,"black","2","6,4"),b=u.getTotalLength();await Promise.all([a(u,b),a(k,b)])}}}function V(t,e,o){const r=x(),n=!!e;o.innerHTML=n?`${e.names.en_gb}`:"Select a track!",o.classList.toggle("track-selected-title-text",n),z(e),B(),n?K():q(),r.forEach(s=>{s===t&&n?(s.classList.add("iconSelected"),s.classList.remove("iconNotSelected")):(s.classList.remove("iconSelected"),s.classList.toggle("iconNotSelected",n))})}async function Y(){const[t,e]=await Promise.all([fetch("/mkw-pathgen//data/race_terms.json"),fetch("/mkw-pathgen//data/mario_terms.json")]);if(!t.ok)throw new Error("Failed to load race_terms.json data");if(!e.ok)throw new Error("Failed to load mario_terms.json data");const o=await t.json(),r=await e.json();return{raceTerms:o,marioTerms:r}}let E=null,S=null;async function W(){if(E&&S)return;const t=await Y();E=t.raceTerms,S=t.marioTerms}function A(t){if(!E||!S)throw new Error("RaceNameStore not initialized. Call initRaceNameStore() first.");const e=E[t];if(!e||e.length===0)throw new Error(`No race terms found for: ${t}`);const o=S[Math.floor(Math.random()*S.length)],r=e[Math.floor(Math.random()*e.length)];return`${o} ${r}`}function O(){const t=document.querySelector(".path-results-text");t&&(t.innerHTML="")}function J(t,e){O();const o=document.querySelector(".path-results-text");if(!o)return;e.length===0&&(o.innerHTML="No Path Found from Selected Track");const r=document.createElement("div");r.className="path-results-title";const n=document.createElement("h1");t==="gp"?n.innerText=A("4gp"):t==="kt"?n.innerText=A("6rally"):n.innerText=A((e.length-1).toString()),r.appendChild(n),o.appendChild(r);const s=$(),a=document.createElement("ul");a.className="path-results-list";const l=document.createElement("span");l.innerHTML=">>>";for(let h=1;h<e.length;h++){const p=e[h-1],m=e[h],c=document.createElement("li");if(p===m){c.className="path-list-item single-track-row";const i=document.createElement("span");i.className="single-track-text",i.textContent=`${s[m].names.en_gb} (3 laps)`,c.appendChild(i)}else{c.className="path-list-item";const i=document.createElement("span");i.className="track-left",i.textContent=s[p].names.en_gb;const g=document.createElement("span");g.className="track-arrow",g.textContent=">>>";const f=document.createElement("span");f.className="track-right",f.textContent=s[m].names.en_gb,c.appendChild(i),c.appendChild(g),c.appendChild(f)}a.appendChild(c)}o.appendChild(a)}function Q(t,e,o,r){B(),O(),o&&o!==t&&o.classList.remove("iconSelected");const n=t.classList.toggle("iconSelected"),s=n?t:null,a=n?e:null;return V(t,a,r),{newSelectedIcon:s,newSelectedTrack:a}}function _(t,e,o,r,n){const a=$()[t.id];t.style.width=`${e}px`,t.style.height=`${e}px`,t.style.left=`${a.coords.X*r-o}px`,t.style.top=`${a.coords.Y*n-o}px`}function U(t,e){const o=e.offsetWidth/e.naturalWidth,r=e.offsetHeight/e.naturalHeight,n=e.height/8,s=n/2,a=document.querySelector(".selected-track-text");let l=null;const h=$();t.innerHTML="";for(const p of Object.values(h)){const m=document.createElement("img");m.className="track-icon",m.id=p.id,m.src=`/mkw-pathgen/images/track-icons/${p.icon}`,m.alt=p.names.en_gb,m.style.position="absolute",_(m,n,s,o,r),m.addEventListener("click",()=>{l=Q(m,p,l,a).newSelectedIcon}),t.appendChild(m)}}function Z(t,e){requestAnimationFrame(()=>{const o=e.getBoundingClientRect();t.style.width=`${o.width}px`,t.style.height=`${o.height}px`,t.style.left=`${o.left+window.scrollX}px`})}function tt(t,e){requestAnimationFrame(()=>{const o=e.getBoundingClientRect();t.style.width=`${o.width}px`})}function et(t){const e=t.offsetWidth/t.naturalWidth,o=t.offsetHeight/t.naturalHeight,r=t.height/8,n=r/2;let s=x();if(s.length>0){for(let a of s)_(a,r,n,e,o);return}}function N(t){const e=[...t];for(let o=0;o<3;o++)for(let r=e.length-1;r>0;r--){const n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function L(...t){}function v(...t){console.log(...t)}function C(t,e,o,r,n=!1,s=!1){const a=[],l=new Set,h=new Set,p=new Set,m=c=>{if(a.length>=r)return!0;a.push(c);const i=t[c];if(!i)return a.pop(),!1;const g=n?[...i.children,i.id]:i.children,f=n?[...i.parents,i.id]:i.parents,w=N(o==="forward"?g:f);let y=[];for(const d of w){const u=d===c;if(a.length>=2&&a[a.length-2]===d||!s&&l.has(d)&&!u||n&&c==="21"&&c===d)continue;const k=`${c}->${d}`;h.has(k)||u&&p.has(c)||y.push(d)}if(y.length===0)return a.pop(),!1;for(const d of y){const u=d===c;u?p.add(c):l.add(d);const k=`${c}->${d}`;if(h.add(k),m(d))return!0;h.delete(k),u?p.delete(c):l.delete(d)}return a.pop(),!1};return m(e),a}function nt(t,e,o){let l=C(t,e,o?"backward":"forward",4,!1,!1);return o&&(l=l.reverse()),l.unshift(l[0]),l.length<5?(v(`No Grand Prix found ${o?"to":"from"} ${t[e].names.en_gb}`),[]):l}function ot(t,e,o){const r=o?"backward":"forward",n=6;let l=C(t,e,r,n,!1,!1);return o&&(l=l.reverse()),l.length<n?(v(`No Knockout Tour found ${o?"to":"from"} ${t[e].names.en_gb}`),[]):l}function rt(t,e,o,r,n){const s=r?"backward":"forward",a=o+1;let h=C(t,e,s,a,n,!0);return r&&(h=h.reverse()),h.length<a?(v(`No VS (${o} races) found ${r?"to":"from"} ${t[e].names.en_gb}`),[]):h}function st(t,e,o){const r=D();if(!r){v("No track selected");return}const n=$();L("Selected track:",r.names.en_gb),L("Selected path mode:",t.value),L('Selected "end with":',e.checked),L("Selected include single-track:",o.checked);const s=t.value,a=(()=>{if(s==="gp")return nt(n,r.id,e.checked);if(s==="kt")return ot(n,r.id,e.checked);if(s.startsWith("vs")){const l=Number(s.replace("vs",""));return rt(n,r.id,l,e.checked,o.checked)}return["How did you get here"]})();v(`Resulting path: ${a}`),J(s,a),H(a)}function j(t,e){const o=t.startsWith("vs");e.disabled=!o,o||(e.checked=!1)}async function ct(){console.log("1.1.0");const e={trackIconLayer:document.querySelector(".track-icons-layer"),mapImg:document.querySelector(".base-map"),pathGenControls:document.querySelector(".map-controls"),generateButton:document.querySelector(".generate-button"),pathModeSelect:document.querySelector(".path-options-dropdown"),selectedTrackEndCheck:document.querySelector(".selected-track-end"),includeSingleTrackCheck:document.querySelector(".include-single-track")},o=Object.entries(e).filter(([,i])=>i===null).map(([i])=>i);if(o.length>0){const i=o.length>1?"s":"";console.error(`Missing required DOM element${i}: ${o.join(", ")}`);return}const{trackIconLayer:r,mapImg:n,pathGenControls:s,generateButton:a,pathModeSelect:l,selectedTrackEndCheck:h,includeSingleTrackCheck:p}=e;await G(),await W(),q(),a.addEventListener("click",()=>st(l,h,p)),j(l.value,p),l.addEventListener("change",()=>j(l.value,p));function m(){Z(r,n),tt(s,n),et(n)}function c(){U(r,n),m()}n.complete?c():n.addEventListener("load",c),window.addEventListener("resize",m)}ct();
