(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))c(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&c(s)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function c(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();function I(t,e){requestAnimationFrame(()=>{const r=e.getBoundingClientRect();t.style.width=`${r.width}px`,t.style.height=`${r.height}px`,t.style.left=`${r.left+window.scrollX}px`})}function q(t,e){requestAnimationFrame(()=>{const r=e.getBoundingClientRect();t.style.width=`${r.width}px`})}async function x(){const[t,e]=await Promise.all([fetch("/mkw-pathgen//data/tracks.json"),fetch("/mkw-pathgen//data/adjacency.json")]);if(!t.ok)throw new Error("Failed to load tracks.json data");if(!e.ok)throw new Error("Failed to load adjacency.json data");const r=await t.json(),c=await e.json(),n={};for(const[o,s]of Object.entries(r))n[o]={id:o,...s,parents:[],children:[]};for(const[o,s]of Object.entries(c)){n[o].children=s;for(const a of s)n[a].parents.push(o)}return n}let w=null;async function P(t){w||(w=await x(),t.textContent=JSON.stringify(w))}function L(){if(!w)throw new Error("TrackMap not yet initialised. Call initTrackMapStore() first.");return w}function E(){const t=document.querySelector("#selected-track-store");if(!t)throw new Error("SelectedTrackStore: #selected-track-store element not found");return t}function R(t){let e=E();e.textContent=t?JSON.stringify(t):""}function j(){const e=E().textContent;if(!e)return null;try{return JSON.parse(e)}catch{return console.warn("SelectedTrackStore: Failed to parse stored track JSON"),null}}function T(){return Array.from(document.querySelectorAll(".track-icon"))}const $=(()=>{const t=document.querySelector(".generate-button");if(!t)throw new Error("Generate button not found");return t})();function M(){$.disabled=!0}function O(){$.disabled=!1}function C(t){T().forEach(r=>{r.classList.remove("path")}),t.forEach(r=>{const c=document.getElementById(r);c&&!c.classList.contains("path")&&c.classList.add("path")})}function A(){const t=document.querySelector(".path-lines-layer");t.innerHTML=""}async function B(t){const e=document.querySelector(".path-lines-layer");if(!e)return;A(),C(t);const r=o=>{const s=o.getBoundingClientRect(),a=e.getBoundingClientRect();return[s.left+s.width/2-a.left,s.top+s.height/2-a.top]},c=async(o,s,a,l,u,i,d)=>{const h=document.createElementNS("http://www.w3.org/2000/svg","path"),m=`M ${o} ${s} L ${a} ${l}`;h.setAttribute("d",m),h.setAttribute("stroke",u),h.setAttribute("stroke-width",i),h.setAttribute("fill","none"),h.setAttribute("stroke-linecap","round"),d&&h.setAttribute("stroke-dasharray",d);const f=h.getTotalLength();return h.setAttribute("stroke-dasharray",d??f.toString()),h.setAttribute("stroke-dashoffset",f.toString()),e.appendChild(h),h.animate([{strokeDashoffset:f},{strokeDashoffset:0}],{duration:500,easing:"ease-out",fill:"forwards"}).finished},n=async(o,s)=>{const l=(f,g,k,S)=>{const p=document.createElementNS("http://www.w3.org/2000/svg","circle");return p.setAttribute("cx",o.toString()),p.setAttribute("cy",s.toString()),p.setAttribute("r","50"),p.setAttribute("stroke",f),p.setAttribute("stroke-width",g.toString()),p.setAttribute("fill","none"),k&&p.setAttribute("stroke-dasharray",k),S!==void 0&&(p.style.opacity=S.toString()),p},u=async f=>{const g=2*Math.PI*50;return f.setAttribute("stroke-dasharray",g.toString()),f.setAttribute("stroke-dashoffset",g.toString()),e.appendChild(f),f.animate([{strokeDashoffset:g},{strokeDashoffset:0}],{duration:500,easing:"ease-out",fill:"forwards"}).finished},i=async f=>(e.appendChild(f),f.animate([{opacity:0},{opacity:1}],{duration:500,easing:"ease-out",fill:"forwards"}).finished),d=l("black",16),h=l("white",10),m=l("black",2,"6,4",0);await Promise.all([u(d),u(h)]),await i(m)};for(let o=0;o<t.length-1;o++){const s=document.getElementById(t[o]),a=document.getElementById(t[o+1]);if(!s||!a)continue;const[l,u]=r(s),[i,d]=r(a);t[o]===t[o+1]?await n(l,u):(await Promise.all([c(l,u,i,d,"black","16"),c(l,u,i,d,"white","10")]),await c(l,u,i,d,"black","2","6,4"))}}function N(t,e,r){const c=T(),n=!!e;r.innerHTML=n?e.names.en_gb:"Select a track!",r.classList.toggle("track-selected-title-text",n),R(e),C([]),A(),n?O():M(),c.forEach(o=>{o===t&&n?(o.classList.add("iconSelected"),o.classList.remove("iconNotSelected")):(o.classList.remove("iconSelected"),o.classList.toggle("iconNotSelected",n))})}function F(t,e,r,c){r&&r!==t&&r.classList.remove("iconSelected");const n=t.classList.toggle("iconSelected"),o=n?t:null,s=n?e:null;return N(t,s,c),{newSelectedIcon:o,newSelectedTrack:s}}function G(t,e){const r=e.offsetWidth/e.naturalWidth,c=e.offsetHeight/e.naturalHeight;t.innerHTML="";const n=e.height/8,o=n/2,s=document.querySelector(".selected-track-text");let a=null;const l=L();for(const u of Object.values(l)){const i=document.createElement("img");i.className="track-icon",i.id=u.id,i.src=`/mkw-pathgen/images/track-icons/${u.icon}`,i.alt=u.names.en_gb,i.style.position="absolute",i.style.width=`${n}px`,i.style.height=`${n}px`,i.style.left=`${u.coords.X*r-o}px`,i.style.top=`${u.coords.Y*c-o}px`,i.addEventListener("click",()=>{a=F(i,u,a,s).newSelectedIcon}),t.appendChild(i)}}function b(t){const e=[...t];for(let r=0;r<3;r++)for(let c=e.length-1;c>0;c--){const n=Math.floor(Math.random()*(c+1));[e[c],e[n]]=[e[n],e[c]]}return e}function y(t,e,r,c,n=!1,o=!1){const s=[],a=new Set,l=new Set,u=i=>{if(s.length>=c)return;s.push(i);const d=t[i];if(!d)return;const h=n?[...d.children,d.id]:d.children,m=n?[...d.parents,d.id]:d.parents,f=b(r==="forward"?h:m);console.debug(i,f);for(const g of f){if(s.length>=c)break;if(s.length>=2&&s[s.length-2]===g||!o&&a.has(g))continue;const k=`${i}->${g}`;l.has(k)||(a.add(g),l.add(k),u(g))}};return u(e),s.slice(0,c)}function H(t,e,r){let a=y(t,e,r?"backward":"forward",4,!1,!1);return console.debug(`First: ${a}`),r&&(a=a.reverse()),a.unshift(a[0]),console.debug(`Second: ${a}`),a.length<5?[]:a}function D(t,e,r){const c=r?"backward":"forward",n=6;let a=y(t,e,c,n,!1,!1);return console.debug(`First: ${a}`),r&&(a=a.reverse()),console.debug(`Second: ${a}`),a.length<n?[]:a}function J(t,e,r,c,n){const o=c?"backward":"forward",s=r+1;let l=y(t,e,o,s,n,!0);return console.debug(`First: ${l}`),c&&(l=l.reverse()),console.debug(`Second: ${l}`),l.length<s?[]:l}function z(t,e,r){const c=j();if(!c){console.log("No track selected");return}const n=L();console.log("Selected track:",c.names.en_gb),console.log("Selected path mode:",t.value),console.log('Selected "end with":',e.checked),console.log("Selected include single-track:",r.checked);const o=(()=>{const s=t.value;if(s==="gp")return H(n,c.id,e.checked);if(s==="kt")return D(n,c.id,e.checked);if(s.startsWith("vs")){const a=Number(s.replace("vs",""));return J(n,c.id,a,e.checked,r.checked)}return["How did you get here"]})();console.log(o),B(o)}function v(t,e){const r=t.startsWith("vs");e.disabled=!r,r||(e.checked=!1)}async function K(){const t={trackMapStore:document.querySelector("#track-map-store"),selectedTrackStore:document.querySelector("#selected-track-store"),trackIconLayer:document.querySelector(".track-icons-layer"),mapImg:document.querySelector(".base-map"),pathGenControls:document.querySelector(".map-controls"),generateButton:document.querySelector(".generate-button"),pathModeSelect:document.querySelector(".path-options-dropdown"),selectedTrackEndCheck:document.querySelector(".selected-track-end"),includeSingleTrackCheck:document.querySelector(".include-single-track")},e=Object.entries(t).filter(([,d])=>d===null).map(([d])=>d);if(e.length>0){const d=e.length>1?"s":"";console.error(`Missing required DOM element${d}: ${e.join(", ")}`);return}const{trackMapStore:r,trackIconLayer:c,mapImg:n,pathGenControls:o,generateButton:s,pathModeSelect:a,selectedTrackEndCheck:l,includeSingleTrackCheck:u}=t;await P(r),M(),s.addEventListener("click",()=>z(a,l,u)),v(a.value,u),a.addEventListener("change",()=>v(a.value,u));function i(){I(c,n),q(o,n),G(c,n)}n.complete?i():n.addEventListener("load",i),window.addEventListener("resize",i)}K();
