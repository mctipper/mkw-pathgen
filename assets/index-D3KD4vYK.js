(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();function A(){return Array.from(document.querySelectorAll(".track-icon"))}async function B(){const[t,e]=await Promise.all([fetch("/mkw-pathgen//data/tracks.json"),fetch("/mkw-pathgen//data/adjacency.json")]);if(!t.ok)throw new Error("Failed to load tracks.json data");if(!e.ok)throw new Error("Failed to load adjacency.json data");const o=await t.json(),r=await e.json(),n={};for(const[s,c]of Object.entries(o))n[s]={id:s,...c,parents:[],children:[]};for(const[s,c]of Object.entries(r)){n[s].children=c;for(const i of c)n[i].parents.push(s)}return n}let b=null;async function H(t){b||(b=await B(),t.textContent=JSON.stringify(b))}function E(){if(!b)throw new Error("TrackMap not yet initialised. Call initTrackMapStore() first.");return b}function I(){const t=document.querySelector("#selected-track-store");if(!t)throw new Error("SelectedTrackStore: #selected-track-store element not found");return t}function _(t){let e=I();e.textContent=t?JSON.stringify(t):""}function F(){const e=I().textContent;if(!e)return null;try{return JSON.parse(e)}catch{return console.warn("SelectedTrackStore: Failed to parse stored track JSON"),null}}const N=(()=>{const t=document.querySelector(".generate-button");if(!t)throw new Error("Generate button not found");return t})();function R(){N.disabled=!0}function G(){N.disabled=!1}let x=0;function K(t){A().forEach(o=>{o.classList.remove("path")}),t.forEach(o=>{const r=document.getElementById(o);r&&!r.classList.contains("path")&&r.classList.add("path")})}function P(){j([])}async function j(t){const e=++x,o=document.querySelector(".path-lines-layer");if(!o)return;const r=document.querySelector(".base-map");if(!r)return;o.innerHTML="",K(t);const n=a=>{const l=a.getBoundingClientRect(),m=o.getBoundingClientRect();return[l.left+l.width/2-m.left,l.top+l.height/2-m.top]},s=()=>e!==x,c=async(a,l)=>{const g=a.getAttribute("stroke-dasharray")??l.toString();return a.setAttribute("stroke-dasharray",g),a.setAttribute("stroke-dashoffset",g),o.appendChild(a),a.animate([{strokeDashoffset:parseFloat(g)},{strokeDashoffset:0}],{duration:500,easing:"ease-out",fill:"forwards"}).finished},i=(a,l,m,g,k,y,d)=>{if(s())return;const u=document.createElementNS("http://www.w3.org/2000/svg","path");u.setAttribute("d",`M ${a} ${l} L ${m} ${g}`),u.setAttribute("stroke",k),u.setAttribute("stroke-width",y),u.setAttribute("opacity",d),u.setAttribute("fill","none"),u.setAttribute("stroke-linecap","round"),o.appendChild(u)},f=(a,l,m,g,k,y,d)=>{const u=document.createElementNS("http://www.w3.org/2000/svg","path");return u.setAttribute("d",`M ${a} ${l} L ${m} ${g}`),u.setAttribute("stroke",k),u.setAttribute("stroke-width",y),u.setAttribute("fill","none"),u.setAttribute("stroke-linecap","round"),d&&u.setAttribute("stroke-dasharray",d),u},h=(a,l,m,g,k)=>{const y=r.height/15,d=document.createElementNS("http://www.w3.org/2000/svg","circle");return d.setAttribute("cx",a.toString()),d.setAttribute("cy",l.toString()),d.setAttribute("r",y.toString()),d.setAttribute("stroke",m),d.setAttribute("stroke-width",g.toString()),d.setAttribute("fill","none"),k&&d.setAttribute("stroke-dasharray",k),d},p="0.8";for(let a=0;a<t.length-1;a++){if(s())return;const l=document.getElementById(t[a]),m=document.getElementById(t[a+1]);if(!l||!m)continue;const[g,k]=n(l),[y,d]=n(m);if(t[a]===t[a+1]){const u=r.height/15,w=document.createElementNS("http://www.w3.org/2000/svg","circle");w.setAttribute("cx",g.toString()),w.setAttribute("cy",k.toString()),w.setAttribute("r",u.toString()),w.setAttribute("stroke","black"),w.setAttribute("stroke-width","16"),w.setAttribute("fill","none"),w.setAttribute("opacity",p),o.appendChild(w)}else i(g,k,y,d,"black","16",p)}for(let a=0;a<t.length-1;a++){if(s())return;const l=document.getElementById(t[a]),m=document.getElementById(t[a+1]);if(!l||!m)continue;const[g,k]=n(l),[y,d]=n(m);if(t[a]===t[a+1]){const u=h(g,k,"white",10),w=h(g,k,"black",2,"6,4"),S=r.height/15,$=2*Math.PI*S;await Promise.all([c(u,$),c(w,$)])}else{const u=f(g,k,y,d,"white","10"),w=f(g,k,y,d,"black","2","6,4"),S=u.getTotalLength();await Promise.all([c(u,S),c(w,S)])}}}function D(t,e,o){const r=A(),n=!!e;o.innerHTML=n?`${e.names.en_gb}`:"Select a track!",o.classList.toggle("track-selected-title-text",n),_(e),P(),n?G():R(),r.forEach(s=>{s===t&&n?(s.classList.add("iconSelected"),s.classList.remove("iconNotSelected")):(s.classList.remove("iconSelected"),s.classList.toggle("iconNotSelected",n))})}function q(){const t=document.querySelector(".path-results-text");t&&(t.innerHTML="")}function J(t){q();const e=document.querySelector(".path-results-text");if(!e)return;t.length===0&&(e.innerHTML="No Path Found from Selected Track");const o=E(),r=document.createElement("ul");r.className="path-results-list";const n=document.createElement("span");n.innerHTML=">>>";for(let s=1;s<t.length;s++){const c=t[s-1],i=t[s],f=document.createElement("li");if(c===i){f.className="path-list-item single-track-row";const h=document.createElement("span");h.className="single-track-text",h.textContent=`${o[i].names.en_gb} (3 laps)`,f.appendChild(h)}else{f.className="path-list-item";const h=document.createElement("span");h.className="track-left",h.textContent=o[c].names.en_gb;const p=document.createElement("span");p.className="track-arrow",p.textContent=">>>";const a=document.createElement("span");a.className="track-right",a.textContent=o[i].names.en_gb,f.appendChild(h),f.appendChild(p),f.appendChild(a)}r.appendChild(f)}e.appendChild(r)}function V(t,e,o,r){P(),q(),o&&o!==t&&o.classList.remove("iconSelected");const n=t.classList.toggle("iconSelected"),s=n?t:null,c=n?e:null;return D(t,c,r),{newSelectedIcon:s,newSelectedTrack:c}}function O(t,e,o,r,n){const c=E()[t.id];t.style.width=`${e}px`,t.style.height=`${e}px`,t.style.left=`${c.coords.X*r-o}px`,t.style.top=`${c.coords.Y*n-o}px`}function X(t,e){const o=e.offsetWidth/e.naturalWidth,r=e.offsetHeight/e.naturalHeight,n=e.height/8,s=n/2,c=document.querySelector(".selected-track-text");let i=null;const f=E();t.innerHTML="";for(const h of Object.values(f)){const p=document.createElement("img");p.className="track-icon",p.id=h.id,p.src=`/mkw-pathgen/images/track-icons/${h.icon}`,p.alt=h.names.en_gb,p.style.position="absolute",O(p,n,s,o,r),p.addEventListener("click",()=>{i=V(p,h,i,c).newSelectedIcon}),t.appendChild(p)}}function z(t,e){requestAnimationFrame(()=>{const o=e.getBoundingClientRect();t.style.width=`${o.width}px`,t.style.height=`${o.height}px`,t.style.left=`${o.left+window.scrollX}px`})}function Y(t,e){requestAnimationFrame(()=>{const o=e.getBoundingClientRect();t.style.width=`${o.width}px`})}function W(t){const e=t.offsetWidth/t.naturalWidth,o=t.offsetHeight/t.naturalHeight,r=t.height/8,n=r/2;let s=A();if(s.length>0){for(let c of s)O(c,r,n,e,o);return}}function C(t){const e=[...t];for(let o=0;o<3;o++)for(let r=e.length-1;r>0;r--){const n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function L(...t){}function v(...t){console.log(...t)}function T(t,e,o,r,n=!1,s=!1){const c=[],i=new Set,f=new Set,h=new Set,p=a=>{if(c.length>=r)return!0;c.push(a);const l=t[a];if(!l)return c.pop(),!1;const m=n?[...l.children,l.id]:l.children,g=n?[...l.parents,l.id]:l.parents,k=C(o==="forward"?m:g);let y=[];for(const d of k){const u=d===a;if(c.length>=2&&c[c.length-2]===d||!s&&i.has(d)&&!u)continue;const w=`${a}->${d}`;f.has(w)||u&&h.has(a)||y.push(d)}if(y.length===0)return c.pop(),!1;for(const d of y){const u=d===a;u?h.add(a):i.add(d);const w=`${a}->${d}`;if(f.add(w),p(d))return!0;f.delete(w),u?h.delete(a):i.delete(d)}return c.pop(),!1};return p(e),c}function Q(t,e,o){let i=T(t,e,o?"backward":"forward",4,!1,!1);return o&&(i=i.reverse()),i.unshift(i[0]),i.length<5?(v(`No Grand Prix found ${o?"to":"from"} ${t[e].names.en_gb}`),[]):i}function U(t,e,o){const r=o?"backward":"forward",n=6;let i=T(t,e,r,n,!1,!1);return o&&(i=i.reverse()),i.length<n?(v(`No Knockout Tour found ${o?"to":"from"} ${t[e].names.en_gb}`),[]):i}function Z(t,e,o,r,n){const s=r?"backward":"forward",c=o+1;let f=T(t,e,s,c,n,!0);return r&&(f=f.reverse()),f.length<c?(v(`No VS (${o} races) found ${r?"to":"from"} ${t[e].names.en_gb}`),[]):f}function tt(t,e,o){const r=F();if(!r){v("No track selected");return}const n=E();L("Selected track:",r.names.en_gb),L("Selected path mode:",t.value),L('Selected "end with":',e.checked),L("Selected include single-track:",o.checked);const s=(()=>{const c=t.value;if(c==="gp")return Q(n,r.id,e.checked);if(c==="kt")return U(n,r.id,e.checked);if(c.startsWith("vs")){const i=Number(c.replace("vs",""));return Z(n,r.id,i,e.checked,o.checked)}return["How did you get here"]})();v(`Resulting path: ${s}`),J(s),j(s)}function M(t,e){const o=t.startsWith("vs");e.disabled=!o,o||(e.checked=!1)}async function et(){const t={trackMapStore:document.querySelector("#track-map-store"),selectedTrackStore:document.querySelector("#selected-track-store"),trackIconLayer:document.querySelector(".track-icons-layer"),mapImg:document.querySelector(".base-map"),pathGenControls:document.querySelector(".map-controls"),generateButton:document.querySelector(".generate-button"),pathModeSelect:document.querySelector(".path-options-dropdown"),selectedTrackEndCheck:document.querySelector(".selected-track-end"),includeSingleTrackCheck:document.querySelector(".include-single-track")},e=Object.entries(t).filter(([,l])=>l===null).map(([l])=>l);if(e.length>0){const l=e.length>1?"s":"";console.error(`Missing required DOM element${l}: ${e.join(", ")}`);return}const{trackMapStore:o,trackIconLayer:r,mapImg:n,pathGenControls:s,generateButton:c,pathModeSelect:i,selectedTrackEndCheck:f,includeSingleTrackCheck:h}=t;await H(o),R(),c.addEventListener("click",()=>tt(i,f,h)),M(i.value,h),i.addEventListener("change",()=>M(i.value,h));function p(){z(r,n),Y(s,n),W(n)}function a(){X(r,n),p()}n.complete?a():n.addEventListener("load",a),window.addEventListener("resize",p)}et();
