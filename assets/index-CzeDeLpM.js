(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();function P(e,t){requestAnimationFrame(()=>{const o=t.getBoundingClientRect();e.style.width=`${o.width}px`,e.style.height=`${o.height}px`,e.style.left=`${o.left+window.scrollX}px`})}function j(e,t){requestAnimationFrame(()=>{const o=t.getBoundingClientRect();e.style.width=`${o.width}px`})}async function O(){const[e,t]=await Promise.all([fetch("/mkw-pathgen//data/tracks.json"),fetch("/mkw-pathgen//data/adjacency.json")]);if(!e.ok)throw new Error("Failed to load tracks.json data");if(!t.ok)throw new Error("Failed to load adjacency.json data");const o=await e.json(),r=await t.json(),n={};for(const[s,c]of Object.entries(o))n[s]={id:s,...c,parents:[],children:[]};for(const[s,c]of Object.entries(r)){n[s].children=c;for(const a of c)n[a].parents.push(s)}return n}let b=null;async function B(e){b||(b=await O(),e.textContent=JSON.stringify(b))}function v(){if(!b)throw new Error("TrackMap not yet initialised. Call initTrackMapStore() first.");return b}function $(){const e=document.querySelector("#selected-track-store");if(!e)throw new Error("SelectedTrackStore: #selected-track-store element not found");return e}function F(e){let t=$();t.textContent=e?JSON.stringify(e):""}function H(){const t=$().textContent;if(!t)return null;try{return JSON.parse(t)}catch{return console.warn("SelectedTrackStore: Failed to parse stored track JSON"),null}}function M(){return Array.from(document.querySelectorAll(".track-icon"))}const R=(()=>{const e=document.querySelector(".generate-button");if(!e)throw new Error("Generate button not found");return e})();function I(){R.disabled=!0}function G(){R.disabled=!1}let T=0;function D(e){M().forEach(o=>{o.classList.remove("path")}),e.forEach(o=>{const r=document.getElementById(o);r&&!r.classList.contains("path")&&r.classList.add("path")})}function N(){q([])}async function q(e){const t=++T,o=document.querySelector(".path-lines-layer");if(!o)return;const r=document.querySelector(".base-map");if(!r)return;o.innerHTML="",D(e);const n=i=>{const l=i.getBoundingClientRect(),d=o.getBoundingClientRect();return[l.left+l.width/2-d.left,l.top+l.height/2-d.top]},s=()=>t!==T,c=async(i,l,d,u,h,k,m)=>{if(s())return;const p=document.createElementNS("http://www.w3.org/2000/svg","path"),y=`M ${i} ${l} L ${d} ${u}`;p.setAttribute("d",y),p.setAttribute("stroke",h),p.setAttribute("stroke-width",k),p.setAttribute("fill","none"),p.setAttribute("stroke-linecap","round"),m&&p.setAttribute("stroke-dasharray",m);const f=p.getTotalLength();return p.setAttribute("stroke-dasharray",m??f.toString()),p.setAttribute("stroke-dashoffset",f.toString()),o.appendChild(p),p.animate([{strokeDashoffset:f},{strokeDashoffset:0}],{duration:500,easing:"ease-out",fill:"forwards"}).finished},a=async(i,l)=>{if(s())return;const d=r.height/15,u=(f,g,S,L)=>{const w=document.createElementNS("http://www.w3.org/2000/svg","circle");return w.setAttribute("cx",i.toString()),w.setAttribute("cy",l.toString()),w.setAttribute("r",d.toString()),w.setAttribute("stroke",f),w.setAttribute("stroke-width",g.toString()),w.setAttribute("fill","none"),S&&w.setAttribute("stroke-dasharray",S),L!==void 0&&(w.style.opacity=L.toString()),w},h=async f=>{const g=2*Math.PI*d;return f.setAttribute("stroke-dasharray",g.toString()),f.setAttribute("stroke-dashoffset",g.toString()),o.appendChild(f),f.animate([{strokeDashoffset:g},{strokeDashoffset:0}],{duration:500,easing:"ease-out",fill:"forwards"}).finished},k=async f=>s()?void 0:(o.appendChild(f),f.animate([{opacity:0},{opacity:1}],{duration:500,easing:"ease-out",fill:"forwards"}).finished),m=u("black",16),p=u("white",10),y=u("black",2,"6,4",0);await Promise.all([h(m),h(p)]),await k(y)};for(let i=0;i<e.length-1;i++){if(s())return;const l=document.getElementById(e[i]),d=document.getElementById(e[i+1]);if(!l||!d)continue;const[u,h]=n(l),[k,m]=n(d);e[i]===e[i+1]?await a(u,h):(await Promise.all([c(u,h,k,m,"black","16"),c(u,h,k,m,"white","10")]),await c(u,h,k,m,"black","2","6,4"))}}function _(e,t,o){const r=M(),n=!!t;o.innerHTML=n?`< ${t.names.en_gb} >`:"Select a track!",o.classList.toggle("track-selected-title-text",n),F(t),N(),n?G():I(),r.forEach(s=>{s===e&&n?(s.classList.add("iconSelected"),s.classList.remove("iconNotSelected")):(s.classList.remove("iconSelected"),s.classList.toggle("iconNotSelected",n))})}function A(){const e=document.querySelector(".path-results-text");e&&(e.innerHTML="")}function J(e){A();const t=document.querySelector(".path-results-text");if(!t)return;e.length===0&&(t.innerHTML="No Path Found from Selected Track");const o=v(),r=document.createElement("ul");r.className="path-results-list";const n=document.createElement("span");n.innerHTML=">>>";for(let s=1;s<e.length;s++){const c=e[s-1],a=e[s],i=document.createElement("li");if(c===a){i.className="path-list-item single-track-row";const l=document.createElement("span");l.className="single-track-text",l.textContent=`${o[a].names.en_gb} (3 laps)`,i.appendChild(l)}else{i.className="path-list-item";const l=document.createElement("span");l.className="track-left",l.textContent=o[c].names.en_gb;const d=document.createElement("span");d.className="track-arrow",d.textContent=">>>";const u=document.createElement("span");u.className="track-right",u.textContent=o[a].names.en_gb,i.appendChild(l),i.appendChild(d),i.appendChild(u)}r.appendChild(i)}t.appendChild(r)}function K(e,t,o,r){N(),A(),o&&o!==e&&o.classList.remove("iconSelected");const n=e.classList.toggle("iconSelected"),s=n?e:null,c=n?t:null;return _(e,c,r),{newSelectedIcon:s,newSelectedTrack:c}}function z(e,t){const o=t.offsetWidth/t.naturalWidth,r=t.offsetHeight/t.naturalHeight;e.innerHTML="";const n=t.height/8,s=n/2,c=document.querySelector(".selected-track-text");let a=null;const i=v();for(const l of Object.values(i)){const d=document.createElement("img");d.className="track-icon",d.id=l.id,d.src=`/mkw-pathgen/images/track-icons/${l.icon}`,d.alt=l.names.en_gb,d.style.position="absolute",d.style.width=`${n}px`,d.style.height=`${n}px`,d.style.left=`${l.coords.X*o-s}px`,d.style.top=`${l.coords.Y*r-s}px`,d.addEventListener("click",()=>{a=K(d,l,a,c).newSelectedIcon}),e.appendChild(d)}}function C(e){const t=[...e];for(let o=0;o<3;o++)for(let r=t.length-1;r>0;r--){const n=Math.floor(Math.random()*(r+1));[t[r],t[n]]=[t[n],t[r]]}return t}function E(e,t,o,r,n=!1,s=!1){const c=[],a=new Set,i=new Set,l=new Set,d=u=>{if(c.length>=r)return!0;c.push(u);const h=e[u];if(!h)return c.pop(),!1;const k=n?[...h.children,h.id]:h.children,m=n?[...h.parents,h.id]:h.parents,p=C(o==="forward"?k:m);console.debug(u,p);let y=[];for(const f of p){const g=f===u;if(c.length>=2&&c[c.length-2]===f||!s&&a.has(f)&&!g)continue;const S=`${u}->${f}`;i.has(S)||g&&l.has(u)||y.push(f)}if(y.length===0)return c.pop(),!1;for(const f of y){const g=f===u;g?l.add(u):a.add(f);const S=`${u}->${f}`;if(i.add(S),d(f))return!0;i.delete(S),g?l.delete(u):a.delete(f)}return c.pop(),!1};return d(t),c}function V(e,t,o){let a=E(e,t,o?"backward":"forward",4,!1,!1);return console.debug(`First: ${a}`),o&&(a=a.reverse()),a.unshift(a[0]),console.debug(`Second: ${a}`),a.length<5?[]:a}function X(e,t,o){const r=o?"backward":"forward",n=6;let a=E(e,t,r,n,!1,!1);return console.debug(`First: ${a}`),o&&(a=a.reverse()),console.debug(`Second: ${a}`),a.length<n?[]:a}function W(e,t,o,r,n){const s=r?"backward":"forward",c=o+1;let i=E(e,t,s,c,n,!0);return console.debug(`First: ${i}`),r&&(i=i.reverse()),console.debug(`Second: ${i}`),i.length<c?[]:i}function Y(e,t,o){const r=H();if(!r){console.log("No track selected");return}const n=v();console.log("Selected track:",r.names.en_gb),console.log("Selected path mode:",e.value),console.log('Selected "end with":',t.checked),console.log("Selected include single-track:",o.checked);const s=(()=>{const c=e.value;if(c==="gp")return V(n,r.id,t.checked);if(c==="kt")return X(n,r.id,t.checked);if(c.startsWith("vs")){const a=Number(c.replace("vs",""));return W(n,r.id,a,t.checked,o.checked)}return["How did you get here"]})();console.log(s),J(s),q(s)}function x(e,t){const o=e.startsWith("vs");t.disabled=!o,o||(t.checked=!1)}async function Q(){const e={trackMapStore:document.querySelector("#track-map-store"),selectedTrackStore:document.querySelector("#selected-track-store"),trackIconLayer:document.querySelector(".track-icons-layer"),mapImg:document.querySelector(".base-map"),pathGenControls:document.querySelector(".map-controls"),generateButton:document.querySelector(".generate-button"),pathModeSelect:document.querySelector(".path-options-dropdown"),selectedTrackEndCheck:document.querySelector(".selected-track-end"),includeSingleTrackCheck:document.querySelector(".include-single-track")},t=Object.entries(e).filter(([,u])=>u===null).map(([u])=>u);if(t.length>0){const u=t.length>1?"s":"";console.error(`Missing required DOM element${u}: ${t.join(", ")}`);return}const{trackMapStore:o,trackIconLayer:r,mapImg:n,pathGenControls:s,generateButton:c,pathModeSelect:a,selectedTrackEndCheck:i,includeSingleTrackCheck:l}=e;await B(o),I(),c.addEventListener("click",()=>Y(a,i,l)),x(a.value,l),a.addEventListener("change",()=>x(a.value,l));function d(){P(r,n),j(s,n),z(r,n)}n.complete?d():n.addEventListener("load",d),window.addEventListener("resize",d)}Q();
