(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();function x(){return Array.from(document.querySelectorAll(".track-icon"))}async function V(){const[t,e]=await Promise.all([fetch("/mkw-pathgen//data/tracks.json"),fetch("/mkw-pathgen//data/adjacency.json")]);if(!t.ok)throw new Error("Failed to load tracks.json data");if(!e.ok)throw new Error("Failed to load adjacency.json data");const n=await t.json(),r=await e.json(),o={};for(const[s,c]of Object.entries(n))o[s]={id:s,...c,parents:[],children:[]};for(const[s,c]of Object.entries(r)){o[s].children=c;for(const l of c)o[l].parents.push(s)}return o}let T=null;async function F(){T||(T=await V())}function E(){if(!T)throw new Error("TrackMap not yet initialised. Call initTrackMapStore() first.");return T}let I=null;function G(t){I=t}function z(){return I}const H=(()=>{const t=document.querySelector(".generate-button");if(!t)throw new Error("Generate button not found");return t})();function P(){H.disabled=!0}function D(){H.disabled=!1}let N=0;function K(t){x().forEach(n=>{n.classList.remove("path")}),t.forEach(n=>{const r=document.getElementById(n);r&&!r.classList.contains("path")&&r.classList.add("path")})}function q(){B([])}async function B(t){const e=++N,n=document.querySelector(".path-lines-layer");if(!n)return;const r=document.querySelector(".base-map");if(!r)return;n.innerHTML="",K(t);const o=a=>{const i=a.getBoundingClientRect(),f=n.getBoundingClientRect();return[i.left+i.width/2-f.left,i.top+i.height/2-f.top]},s=()=>e!==N,c=async(a,i)=>{const h=a.getAttribute("stroke-dasharray")??i.toString();return a.setAttribute("stroke-dasharray",h),a.setAttribute("stroke-dashoffset",h),n.appendChild(a),a.animate([{strokeDashoffset:parseFloat(h)},{strokeDashoffset:0}],{duration:500,easing:"ease-out",fill:"forwards"}).finished},l=(a,i,f,h,g,y,d)=>{if(s())return;const u=document.createElementNS("http://www.w3.org/2000/svg","path");u.setAttribute("d",`M ${a} ${i} L ${f} ${h}`),u.setAttribute("stroke",g),u.setAttribute("stroke-width",y),u.setAttribute("opacity",d),u.setAttribute("fill","none"),u.setAttribute("stroke-linecap","round"),n.appendChild(u)},w=(a,i,f,h,g,y,d)=>{const u=document.createElementNS("http://www.w3.org/2000/svg","path");return u.setAttribute("d",`M ${a} ${i} L ${f} ${h}`),u.setAttribute("stroke",g),u.setAttribute("stroke-width",y),u.setAttribute("fill","none"),u.setAttribute("stroke-linecap","round"),d&&u.setAttribute("stroke-dasharray",d),u},m=(a,i,f,h,g)=>{const y=r.height/15,d=document.createElementNS("http://www.w3.org/2000/svg","circle");return d.setAttribute("cx",a.toString()),d.setAttribute("cy",i.toString()),d.setAttribute("r",y.toString()),d.setAttribute("stroke",f),d.setAttribute("stroke-width",h.toString()),d.setAttribute("fill","none"),g&&d.setAttribute("stroke-dasharray",g),d},p="0.8";for(let a=0;a<t.length-1;a++){if(s())return;const i=document.getElementById(t[a]),f=document.getElementById(t[a+1]);if(!i||!f)continue;const[h,g]=o(i),[y,d]=o(f);if(t[a]===t[a+1]){const u=r.height/15,k=document.createElementNS("http://www.w3.org/2000/svg","circle");k.setAttribute("cx",h.toString()),k.setAttribute("cy",g.toString()),k.setAttribute("r",u.toString()),k.setAttribute("stroke","black"),k.setAttribute("stroke-width","16"),k.setAttribute("fill","none"),k.setAttribute("opacity",p),n.appendChild(k)}else l(h,g,y,d,"black","16",p)}for(let a=0;a<t.length-1;a++){if(s())return;const i=document.getElementById(t[a]),f=document.getElementById(t[a+1]);if(!i||!f)continue;const[h,g]=o(i),[y,d]=o(f);if(t[a]===t[a+1]){const u=m(h,g,"white",10),k=m(h,g,"black",2,"6,4"),b=r.height/15,M=2*Math.PI*b;await Promise.all([c(u,M),c(k,M)])}else{const u=w(h,g,y,d,"white","10"),k=w(h,g,y,d,"black","2","6,4"),b=u.getTotalLength();await Promise.all([c(u,b),c(k,b)])}}}function X(t,e,n){const r=x(),o=!!e;n.innerHTML=o?`${e.names.en_gb}`:"Select a track!",n.classList.toggle("track-selected-title-text",o),G(e),q(),o?D():P(),r.forEach(s=>{s===t&&o?(s.classList.add("iconSelected"),s.classList.remove("iconNotSelected")):(s.classList.remove("iconSelected"),s.classList.toggle("iconNotSelected",o))})}async function W(){const[t,e]=await Promise.all([fetch("/mkw-pathgen//data/race_terms.json"),fetch("/mkw-pathgen//data/mario_terms.json")]);if(!t.ok)throw new Error("Failed to load race_terms.json data");if(!e.ok)throw new Error("Failed to load mario_terms.json data");const n=await t.json(),r=await e.json();return{raceTerms:n,marioTerms:r}}let A=null,S=null;async function Y(){if(A&&S)return;const t=await W();A=t.raceTerms,S=t.marioTerms}function $(t){if(!A||!S)throw new Error("RaceNameStore not initialized. Call initRaceNameStore() first.");const e=A[t];if(!e||e.length===0)throw new Error(`No race terms found for: ${t}`);const n=S[Math.floor(Math.random()*S.length)],r=e[Math.floor(Math.random()*e.length)];return`${n} ${r}`}function Z(){const t=document.getElementById("generated-path");if(!t)return;const n=window.open("","_blank").document,r=document.head.cloneNode(!0);n.head.innerHTML=r.innerHTML;const o=t.cloneNode(!0);n.body.appendChild(o)}function _(){const t=document.querySelector(".path-results-text");t&&(t.innerHTML="")}function J(t,e){_();const n=document.querySelector(".path-results-text");if(!n)return;e.length===0&&(n.innerHTML="No Path Found from Selected Track");const r=document.createElement("div");r.className="path-results-title";const o=document.createElement("h1");t==="gp"?o.innerText=$("4gp"):t==="kt"?o.innerText=$("6rally"):o.innerText=$((e.length-1).toString()),r.appendChild(o);const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("width","20"),s.setAttribute("height","20"),s.setAttribute("viewBox","0 0 24 24"),s.style.cursor="pointer",s.innerHTML=`
  <path fill="currentColor" d="M14,3H21V10H19V6.41L10.41,15L9,13.59L17.59,5H14V3M5,5H13V7H7V17H17V11H19V19A2,2 0 0,1 17,21H5A2,2 0 0,1 3,19V7A2,2 0 0,1 5,5Z" />
`,s.onclick=Z,r.appendChild(s),n.appendChild(r);const c=E(),l=document.createElement("ul");l.className="path-results-list";const w=document.createElement("span");w.innerHTML=">>>";for(let m=1;m<e.length;m++){const p=e[m-1],a=e[m],i=document.createElement("li");if(p===a){i.className="path-list-item single-track-row";const f=document.createElement("span");f.className="single-track-text",f.textContent=`${c[a].names.en_gb} (3 laps)`,i.appendChild(f)}else{i.className="path-list-item";const f=document.createElement("span");f.className="track-left",f.textContent=c[p].names.en_gb;const h=document.createElement("span");h.className="track-arrow",h.textContent=">>>";const g=document.createElement("span");g.className="track-right",g.textContent=c[a].names.en_gb,i.appendChild(f),i.appendChild(h),i.appendChild(g)}l.appendChild(i)}n.appendChild(l)}function Q(t,e,n,r){q(),_(),n&&n!==t&&n.classList.remove("iconSelected");const o=t.classList.toggle("iconSelected"),s=o?t:null,c=o?e:null;return X(t,c,r),{newSelectedIcon:s,newSelectedTrack:c}}function O(t,e,n,r,o){const c=E()[t.id];t.style.width=`${e}px`,t.style.height=`${e}px`,t.style.left=`${c.coords.X*r-n}px`,t.style.top=`${c.coords.Y*o-n}px`}function U(t,e){const n=e.offsetWidth/e.naturalWidth,r=e.offsetHeight/e.naturalHeight,o=e.height/8,s=o/2,c=document.querySelector(".selected-track-text");let l=null;const w=E();t.innerHTML="";for(const m of Object.values(w)){const p=document.createElement("img");p.className="track-icon",p.id=m.id,p.src=`/mkw-pathgen/images/track-icons/${m.icon}`,p.alt=m.names.en_gb,p.style.position="absolute",O(p,o,s,n,r),p.addEventListener("click",()=>{l=Q(p,m,l,c).newSelectedIcon}),t.appendChild(p)}}function tt(t,e){requestAnimationFrame(()=>{const n=e.getBoundingClientRect();t.style.width=`${n.width}px`,t.style.height=`${n.height}px`,t.style.left=`${n.left+window.scrollX}px`})}function et(t,e){requestAnimationFrame(()=>{const n=e.getBoundingClientRect();t.style.width=`${n.width}px`})}function nt(t){const e=t.offsetWidth/t.naturalWidth,n=t.offsetHeight/t.naturalHeight,r=t.height/8,o=r/2;let s=x();if(s.length>0){for(let c of s)O(c,r,o,e,n);return}}function R(t){const e=[...t];for(let n=0;n<3;n++)for(let r=e.length-1;r>0;r--){const o=Math.floor(Math.random()*(r+1));[e[r],e[o]]=[e[o],e[r]]}return e}function L(...t){}function v(...t){console.log(...t)}function C(t,e,n,r,o=!1,s=!1){const c=[],l=new Set,w=new Set,m=new Set,p=a=>{if(c.length>=r)return!0;c.push(a);const i=t[a];if(!i)return c.pop(),!1;const f=o?[...i.children,i.id]:i.children,h=o?[...i.parents,i.id]:i.parents,g=R(n==="forward"?f:h);let y=[];for(const d of g){const u=d===a;if(c.length>=2&&c[c.length-2]===d||!s&&l.has(d)&&!u||o&&a==="21"&&a===d)continue;const k=`${a}->${d}`;w.has(k)||u&&m.has(a)||y.push(d)}if(y.length===0)return c.pop(),!1;for(const d of y){const u=d===a;u?m.add(a):l.add(d);const k=`${a}->${d}`;if(w.add(k),p(d))return!0;w.delete(k),u?m.delete(a):l.delete(d)}return c.pop(),!1};return p(e),c}function ot(t,e,n){let l=C(t,e,n?"backward":"forward",4,!1,!1);return n&&(l=l.reverse()),l.unshift(l[0]),l.length<5?(v(`No Grand Prix found ${n?"to":"from"} ${t[e].names.en_gb}`),[]):l}function rt(t,e,n){const r=n?"backward":"forward",o=6;let l=C(t,e,r,o,!1,!1);return n&&(l=l.reverse()),l.length<o?(v(`No Knockout Tour found ${n?"to":"from"} ${t[e].names.en_gb}`),[]):l}function st(t,e,n,r,o){const s=r?"backward":"forward",c=n+1;let w=C(t,e,s,c,o,!0);return r&&(w=w.reverse()),w.length<c?(v(`No VS (${n} races) found ${r?"to":"from"} ${t[e].names.en_gb}`),[]):w}function ct(t,e,n){const r=z();if(!r){v("No track selected");return}const o=E();L("Selected track:",r.names.en_gb),L("Selected path mode:",t.value),L('Selected "end with":',e.checked),L("Selected include single-track:",n.checked);const s=t.value,c=(()=>{if(s==="gp")return ot(o,r.id,e.checked);if(s==="kt")return rt(o,r.id,e.checked);if(s.startsWith("vs")){const l=Number(s.replace("vs",""));return st(o,r.id,l,e.checked,n.checked)}return["How did you get here"]})();v(`Resulting path: ${c}`),J(s,c),B(c)}function j(t,e){const n=t.startsWith("vs");e.disabled=!n,n||(e.checked=!1)}async function at(){console.log("1.1.1");const e={trackIconLayer:document.querySelector(".track-icons-layer"),mapImg:document.querySelector(".base-map"),pathGenControls:document.querySelector(".map-controls"),generateButton:document.querySelector(".generate-button"),pathModeSelect:document.querySelector(".path-options-dropdown"),selectedTrackEndCheck:document.querySelector(".selected-track-end"),includeSingleTrackCheck:document.querySelector(".include-single-track")},n=Object.entries(e).filter(([,i])=>i===null).map(([i])=>i);if(n.length>0){const i=n.length>1?"s":"";console.error(`Missing required DOM element${i}: ${n.join(", ")}`);return}const{trackIconLayer:r,mapImg:o,pathGenControls:s,generateButton:c,pathModeSelect:l,selectedTrackEndCheck:w,includeSingleTrackCheck:m}=e;await F(),await Y(),P(),c.addEventListener("click",()=>ct(l,w,m)),j(l.value,m),l.addEventListener("change",()=>j(l.value,m));function p(){tt(r,o),et(s,o),nt(o)}function a(){U(r,o),p()}o.complete?a():o.addEventListener("load",a),window.addEventListener("resize",p)}at();
