(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();function v(){return Array.from(document.querySelectorAll(".track-icon"))}async function j(){const[t,e]=await Promise.all([fetch("/mkw-pathgen//data/tracks.json"),fetch("/mkw-pathgen//data/adjacency.json")]);if(!t.ok)throw new Error("Failed to load tracks.json data");if(!e.ok)throw new Error("Failed to load adjacency.json data");const o=await t.json(),r=await e.json(),n={};for(const[s,c]of Object.entries(o))n[s]={id:s,...c,parents:[],children:[]};for(const[s,c]of Object.entries(r)){n[s].children=c;for(const i of c)n[i].parents.push(s)}return n}let b=null;async function O(t){b||(b=await j(),t.textContent=JSON.stringify(b))}function L(){if(!b)throw new Error("TrackMap not yet initialised. Call initTrackMapStore() first.");return b}function C(){const t=document.querySelector("#selected-track-store");if(!t)throw new Error("SelectedTrackStore: #selected-track-store element not found");return t}function B(t){let e=C();e.textContent=t?JSON.stringify(t):""}function F(){const e=C().textContent;if(!e)return null;try{return JSON.parse(e)}catch{return console.warn("SelectedTrackStore: Failed to parse stored track JSON"),null}}const M=(()=>{const t=document.querySelector(".generate-button");if(!t)throw new Error("Generate button not found");return t})();function I(){M.disabled=!0}function H(){M.disabled=!1}let x=0;function G(t){v().forEach(o=>{o.classList.remove("path")}),t.forEach(o=>{const r=document.getElementById(o);r&&!r.classList.contains("path")&&r.classList.add("path")})}function R(){N([])}async function N(t){const e=++x,o=document.querySelector(".path-lines-layer");if(!o)return;const r=document.querySelector(".base-map");if(!r)return;o.innerHTML="",G(t);const n=a=>{const l=a.getBoundingClientRect(),k=o.getBoundingClientRect();return[l.left+l.width/2-k.left,l.top+l.height/2-k.top]},s=()=>e!==x,c=async(a,l)=>{const p=a.getAttribute("stroke-dasharray")??l.toString();return a.setAttribute("stroke-dasharray",p),a.setAttribute("stroke-dashoffset",p),o.appendChild(a),a.animate([{strokeDashoffset:parseFloat(p)},{strokeDashoffset:0}],{duration:500,easing:"ease-out",fill:"forwards"}).finished},i=(a,l,k,p,m,y,d)=>{if(s())return;const u=document.createElementNS("http://www.w3.org/2000/svg","path");u.setAttribute("d",`M ${a} ${l} L ${k} ${p}`),u.setAttribute("stroke",m),u.setAttribute("stroke-width",y),u.setAttribute("opacity",d),u.setAttribute("fill","none"),u.setAttribute("stroke-linecap","round"),o.appendChild(u)},f=(a,l,k,p,m,y,d)=>{const u=document.createElementNS("http://www.w3.org/2000/svg","path");return u.setAttribute("d",`M ${a} ${l} L ${k} ${p}`),u.setAttribute("stroke",m),u.setAttribute("stroke-width",y),u.setAttribute("fill","none"),u.setAttribute("stroke-linecap","round"),d&&u.setAttribute("stroke-dasharray",d),u},h=(a,l,k,p,m)=>{const y=r.height/15,d=document.createElementNS("http://www.w3.org/2000/svg","circle");return d.setAttribute("cx",a.toString()),d.setAttribute("cy",l.toString()),d.setAttribute("r",y.toString()),d.setAttribute("stroke",k),d.setAttribute("stroke-width",p.toString()),d.setAttribute("fill","none"),m&&d.setAttribute("stroke-dasharray",m),d},g="0.8";for(let a=0;a<t.length-1;a++){if(s())return;const l=document.getElementById(t[a]),k=document.getElementById(t[a+1]);if(!l||!k)continue;const[p,m]=n(l),[y,d]=n(k);if(t[a]===t[a+1]){const u=r.height/15,w=document.createElementNS("http://www.w3.org/2000/svg","circle");w.setAttribute("cx",p.toString()),w.setAttribute("cy",m.toString()),w.setAttribute("r",u.toString()),w.setAttribute("stroke","black"),w.setAttribute("stroke-width","16"),w.setAttribute("fill","none"),w.setAttribute("opacity",g),o.appendChild(w)}else i(p,m,y,d,"black","16",g)}for(let a=0;a<t.length-1;a++){if(s())return;const l=document.getElementById(t[a]),k=document.getElementById(t[a+1]);if(!l||!k)continue;const[p,m]=n(l),[y,d]=n(k);if(t[a]===t[a+1]){const u=h(p,m,"white",10),w=h(p,m,"black",2,"6,4"),S=r.height/15,A=2*Math.PI*S;await Promise.all([c(u,A),c(w,A)])}else{const u=f(p,m,y,d,"white","10"),w=f(p,m,y,d,"black","2","6,4"),S=u.getTotalLength();await Promise.all([c(u,S),c(w,S)])}}}function _(t,e,o){const r=v(),n=!!e;o.innerHTML=n?`${e.names.en_gb}`:"Select a track!",o.classList.toggle("track-selected-title-text",n),B(e),R(),n?H():I(),r.forEach(s=>{s===t&&n?(s.classList.add("iconSelected"),s.classList.remove("iconNotSelected")):(s.classList.remove("iconSelected"),s.classList.toggle("iconNotSelected",n))})}function P(){const t=document.querySelector(".path-results-text");t&&(t.innerHTML="")}function D(t){P();const e=document.querySelector(".path-results-text");if(!e)return;t.length===0&&(e.innerHTML="No Path Found from Selected Track");const o=L(),r=document.createElement("ul");r.className="path-results-list";const n=document.createElement("span");n.innerHTML=">>>";for(let s=1;s<t.length;s++){const c=t[s-1],i=t[s],f=document.createElement("li");if(c===i){f.className="path-list-item single-track-row";const h=document.createElement("span");h.className="single-track-text",h.textContent=`${o[i].names.en_gb} (3 laps)`,f.appendChild(h)}else{f.className="path-list-item";const h=document.createElement("span");h.className="track-left",h.textContent=o[c].names.en_gb;const g=document.createElement("span");g.className="track-arrow",g.textContent=">>>";const a=document.createElement("span");a.className="track-right",a.textContent=o[i].names.en_gb,f.appendChild(h),f.appendChild(g),f.appendChild(a)}r.appendChild(f)}e.appendChild(r)}function J(t,e,o,r){R(),P(),o&&o!==t&&o.classList.remove("iconSelected");const n=t.classList.toggle("iconSelected"),s=n?t:null,c=n?e:null;return _(t,c,r),{newSelectedIcon:s,newSelectedTrack:c}}function q(t,e,o,r,n){const c=L()[t.id];t.style.width=`${e}px`,t.style.height=`${e}px`,t.style.left=`${c.coords.X*r-o}px`,t.style.top=`${c.coords.Y*n-o}px`}function K(t,e){const o=e.offsetWidth/e.naturalWidth,r=e.offsetHeight/e.naturalHeight,n=e.height/8,s=n/2,c=document.querySelector(".selected-track-text");let i=null;const f=L();t.innerHTML="";for(const h of Object.values(f)){const g=document.createElement("img");g.className="track-icon",g.id=h.id,g.src=`/mkw-pathgen/images/track-icons/${h.icon}`,g.alt=h.names.en_gb,g.style.position="absolute",q(g,n,s,o,r),g.addEventListener("click",()=>{i=J(g,h,i,c).newSelectedIcon}),t.appendChild(g)}}function W(t,e){requestAnimationFrame(()=>{const o=e.getBoundingClientRect();t.style.width=`${o.width}px`,t.style.height=`${o.height}px`,t.style.left=`${o.left+window.scrollX}px`})}function X(t,e){requestAnimationFrame(()=>{const o=e.getBoundingClientRect();t.style.width=`${o.width}px`})}function z(t){const e=t.offsetWidth/t.naturalWidth,o=t.offsetHeight/t.naturalHeight,r=t.height/8,n=r/2;let s=v();if(s.length>0){for(let c of s)q(c,r,n,e,o);return}}function T(t){const e=[...t];for(let o=0;o<3;o++)for(let r=e.length-1;r>0;r--){const n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function E(t,e,o,r,n=!1,s=!1){const c=[],i=new Set,f=new Set,h=new Set,g=a=>{if(c.length>=r)return!0;c.push(a);const l=t[a];if(!l)return c.pop(),!1;const k=n?[...l.children,l.id]:l.children,p=n?[...l.parents,l.id]:l.parents,m=T(o==="forward"?k:p);console.debug("raw next:",a,m);let y=[];for(const d of m){const u=d===a;if(c.length>=2&&c[c.length-2]===d||!s&&i.has(d)&&!u)continue;const w=`${a}->${d}`;f.has(w)||u&&h.has(a)||y.push(d)}if(console.debug("validated:",a,y),y.length===0)return c.pop(),!1;for(const d of y){const u=d===a;u?h.add(a):i.add(d);const w=`${a}->${d}`;if(f.add(w),g(d))return!0;f.delete(w),u?h.delete(a):i.delete(d)}return c.pop(),!1};return g(e),c}function V(t,e,o){let i=E(t,e,o?"backward":"forward",4,!1,!1);return console.debug(`First: ${i}`),o&&(i=i.reverse()),i.unshift(i[0]),console.debug(`Second: ${i}`),i.length<5?[]:i}function Y(t,e,o){const r=o?"backward":"forward",n=6;let i=E(t,e,r,n,!1,!1);return console.debug(`First: ${i}`),o&&(i=i.reverse()),console.debug(`Second: ${i}`),i.length<n?[]:i}function Q(t,e,o,r,n){const s=r?"backward":"forward",c=o+1;let f=E(t,e,s,c,n,!0);return console.debug(`First: ${f}`),r&&(f=f.reverse()),console.debug(`Second: ${f}`),f.length<c?[]:f}function U(t,e,o){const r=F();if(!r){console.log("No track selected");return}const n=L();console.log("Selected track:",r.names.en_gb),console.log("Selected path mode:",t.value),console.log('Selected "end with":',e.checked),console.log("Selected include single-track:",o.checked);const s=(()=>{const c=t.value;if(c==="gp")return V(n,r.id,e.checked);if(c==="kt")return Y(n,r.id,e.checked);if(c.startsWith("vs")){const i=Number(c.replace("vs",""));return Q(n,r.id,i,e.checked,o.checked)}return["How did you get here"]})();console.log(s),D(s),N(s)}function $(t,e){const o=t.startsWith("vs");e.disabled=!o,o||(e.checked=!1)}async function Z(){const t={trackMapStore:document.querySelector("#track-map-store"),selectedTrackStore:document.querySelector("#selected-track-store"),trackIconLayer:document.querySelector(".track-icons-layer"),mapImg:document.querySelector(".base-map"),pathGenControls:document.querySelector(".map-controls"),generateButton:document.querySelector(".generate-button"),pathModeSelect:document.querySelector(".path-options-dropdown"),selectedTrackEndCheck:document.querySelector(".selected-track-end"),includeSingleTrackCheck:document.querySelector(".include-single-track")},e=Object.entries(t).filter(([,l])=>l===null).map(([l])=>l);if(e.length>0){const l=e.length>1?"s":"";console.error(`Missing required DOM element${l}: ${e.join(", ")}`);return}const{trackMapStore:o,trackIconLayer:r,mapImg:n,pathGenControls:s,generateButton:c,pathModeSelect:i,selectedTrackEndCheck:f,includeSingleTrackCheck:h}=t;await O(o),I(),c.addEventListener("click",()=>U(i,f,h)),$(i.value,h),i.addEventListener("change",()=>$(i.value,h));function g(){W(r,n),X(s,n),z(n)}function a(){K(r,n),g()}n.complete?a():n.addEventListener("load",a),window.addEventListener("resize",g)}Z();
