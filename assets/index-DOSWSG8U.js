(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();function A(){return Array.from(document.querySelectorAll(".track-icon"))}async function B(){const[t,e]=await Promise.all([fetch("/mkw-pathgen//data/tracks.json"),fetch("/mkw-pathgen//data/adjacency.json")]);if(!t.ok)throw new Error("Failed to load tracks.json data");if(!e.ok)throw new Error("Failed to load adjacency.json data");const n=await t.json(),s=await e.json(),o={};for(const[r,c]of Object.entries(n))o[r]={id:r,...c,parents:[],children:[]};for(const[r,c]of Object.entries(s)){o[r].children=c;for(const i of c)o[i].parents.push(r)}return o}let b=null;async function H(t){b||(b=await B(),t.textContent=JSON.stringify(b))}function E(){if(!b)throw new Error("TrackMap not yet initialised. Call initTrackMapStore() first.");return b}function N(){const t=document.querySelector("#selected-track-store");if(!t)throw new Error("SelectedTrackStore: #selected-track-store element not found");return t}function _(t){let e=N();e.textContent=t?JSON.stringify(t):""}function F(){const e=N().textContent;if(!e)return null;try{return JSON.parse(e)}catch{return console.warn("SelectedTrackStore: Failed to parse stored track JSON"),null}}const I=(()=>{const t=document.querySelector(".generate-button");if(!t)throw new Error("Generate button not found");return t})();function R(){I.disabled=!0}function G(){I.disabled=!1}let x=0;function K(t){A().forEach(n=>{n.classList.remove("path")}),t.forEach(n=>{const s=document.getElementById(n);s&&!s.classList.contains("path")&&s.classList.add("path")})}function P(){j([])}async function j(t){const e=++x,n=document.querySelector(".path-lines-layer");if(!n)return;const s=document.querySelector(".base-map");if(!s)return;n.innerHTML="",K(t);const o=a=>{const d=a.getBoundingClientRect(),p=n.getBoundingClientRect();return[d.left+d.width/2-p.left,d.top+d.height/2-p.top]},r=()=>e!==x,c=async(a,d)=>{const m=a.getAttribute("stroke-dasharray")??d.toString();return a.setAttribute("stroke-dasharray",m),a.setAttribute("stroke-dashoffset",m),n.appendChild(a),a.animate([{strokeDashoffset:parseFloat(m)},{strokeDashoffset:0}],{duration:500,easing:"ease-out",fill:"forwards"}).finished},i=(a,d,p,m,k,y,l)=>{if(r())return;const f=document.createElementNS("http://www.w3.org/2000/svg","path");f.setAttribute("d",`M ${a} ${d} L ${p} ${m}`),f.setAttribute("stroke",k),f.setAttribute("stroke-width",y),f.setAttribute("opacity",l),f.setAttribute("fill","none"),f.setAttribute("stroke-linecap","round"),n.appendChild(f)},u=(a,d,p,m,k,y,l)=>{const f=document.createElementNS("http://www.w3.org/2000/svg","path");return f.setAttribute("d",`M ${a} ${d} L ${p} ${m}`),f.setAttribute("stroke",k),f.setAttribute("stroke-width",y),f.setAttribute("fill","none"),f.setAttribute("stroke-linecap","round"),l&&f.setAttribute("stroke-dasharray",l),f},h=(a,d,p,m,k)=>{const y=s.height/15,l=document.createElementNS("http://www.w3.org/2000/svg","circle");return l.setAttribute("cx",a.toString()),l.setAttribute("cy",d.toString()),l.setAttribute("r",y.toString()),l.setAttribute("stroke",p),l.setAttribute("stroke-width",m.toString()),l.setAttribute("fill","none"),k&&l.setAttribute("stroke-dasharray",k),l},g="0.8";for(let a=0;a<t.length-1;a++){if(r())return;const d=document.getElementById(t[a]),p=document.getElementById(t[a+1]);if(!d||!p)continue;const[m,k]=o(d),[y,l]=o(p);if(t[a]===t[a+1]){const f=s.height/15,w=document.createElementNS("http://www.w3.org/2000/svg","circle");w.setAttribute("cx",m.toString()),w.setAttribute("cy",k.toString()),w.setAttribute("r",f.toString()),w.setAttribute("stroke","black"),w.setAttribute("stroke-width","16"),w.setAttribute("fill","none"),w.setAttribute("opacity",g),n.appendChild(w)}else i(m,k,y,l,"black","16",g)}for(let a=0;a<t.length-1;a++){if(r())return;const d=document.getElementById(t[a]),p=document.getElementById(t[a+1]);if(!d||!p)continue;const[m,k]=o(d),[y,l]=o(p);if(t[a]===t[a+1]){const f=h(m,k,"white",10),w=h(m,k,"black",2,"6,4"),S=s.height/15,$=2*Math.PI*S;await Promise.all([c(f,$),c(w,$)])}else{const f=u(m,k,y,l,"white","10"),w=u(m,k,y,l,"black","2","6,4"),S=f.getTotalLength();await Promise.all([c(f,S),c(w,S)])}}}function D(t,e,n){const s=A(),o=!!e;n.innerHTML=o?`${e.names.en_gb}`:"Select a track!",n.classList.toggle("track-selected-title-text",o),_(e),P(),o?G():R(),s.forEach(r=>{r===t&&o?(r.classList.add("iconSelected"),r.classList.remove("iconNotSelected")):(r.classList.remove("iconSelected"),r.classList.toggle("iconNotSelected",o))})}function q(){const t=document.querySelector(".path-results-text");t&&(t.innerHTML="")}function J(t){q();const e=document.querySelector(".path-results-text");if(!e)return;t.length===0&&(e.innerHTML="No Path Found from Selected Track");const n=E(),s=document.createElement("ul");s.className="path-results-list";const o=document.createElement("span");o.innerHTML=">>>";for(let r=1;r<t.length;r++){const c=t[r-1],i=t[r],u=document.createElement("li");if(c===i){u.className="path-list-item single-track-row";const h=document.createElement("span");h.className="single-track-text",h.textContent=`${n[i].names.en_gb} (3 laps)`,u.appendChild(h)}else{u.className="path-list-item";const h=document.createElement("span");h.className="track-left",h.textContent=n[c].names.en_gb;const g=document.createElement("span");g.className="track-arrow",g.textContent=">>>";const a=document.createElement("span");a.className="track-right",a.textContent=n[i].names.en_gb,u.appendChild(h),u.appendChild(g),u.appendChild(a)}s.appendChild(u)}e.appendChild(s)}function V(t,e,n,s){P(),q(),n&&n!==t&&n.classList.remove("iconSelected");const o=t.classList.toggle("iconSelected"),r=o?t:null,c=o?e:null;return D(t,c,s),{newSelectedIcon:r,newSelectedTrack:c}}function O(t,e,n,s,o){const c=E()[t.id];t.style.width=`${e}px`,t.style.height=`${e}px`,t.style.left=`${c.coords.X*s-n}px`,t.style.top=`${c.coords.Y*o-n}px`}function X(t,e){const n=e.offsetWidth/e.naturalWidth,s=e.offsetHeight/e.naturalHeight,o=e.height/8,r=o/2,c=document.querySelector(".selected-track-text");let i=null;const u=E();t.innerHTML="";for(const h of Object.values(u)){const g=document.createElement("img");g.className="track-icon",g.id=h.id,g.src=`/mkw-pathgen/images/track-icons/${h.icon}`,g.alt=h.names.en_gb,g.style.position="absolute",O(g,o,r,n,s),g.addEventListener("click",()=>{i=V(g,h,i,c).newSelectedIcon}),t.appendChild(g)}}function z(t,e){requestAnimationFrame(()=>{const n=e.getBoundingClientRect();t.style.width=`${n.width}px`,t.style.height=`${n.height}px`,t.style.left=`${n.left+window.scrollX}px`})}function Y(t,e){requestAnimationFrame(()=>{const n=e.getBoundingClientRect();t.style.width=`${n.width}px`})}function W(t){const e=t.offsetWidth/t.naturalWidth,n=t.offsetHeight/t.naturalHeight,s=t.height/8,o=s/2;let r=A();if(r.length>0){for(let c of r)O(c,s,o,e,n);return}}function C(t){const e=[...t];for(let n=0;n<3;n++)for(let s=e.length-1;s>0;s--){const o=Math.floor(Math.random()*(s+1));[e[s],e[o]]=[e[o],e[s]]}return e}function L(...t){}function v(...t){console.log(...t)}function T(t,e,n,s,o=!1,r=!1){const c=[],i=new Set,u=new Set,h=new Set,g=a=>{if(c.length>=s)return!0;c.push(a);const d=t[a];if(!d)return c.pop(),!1;const p=o?[...d.children,d.id]:d.children,m=o?[...d.parents,d.id]:d.parents,k=C(n==="forward"?p:m);let y=[];for(const l of k){const f=l===a;if(c.length>=2&&c[c.length-2]===l||!r&&i.has(l)&&!f||o&&a==="21"&&a===l)continue;const w=`${a}->${l}`;u.has(w)||f&&h.has(a)||y.push(l)}if(y.length===0)return c.pop(),!1;for(const l of y){const f=l===a;f?h.add(a):i.add(l);const w=`${a}->${l}`;if(u.add(w),g(l))return!0;u.delete(w),f?h.delete(a):i.delete(l)}return c.pop(),!1};return g(e),c}function Q(t,e,n){let i=T(t,e,n?"backward":"forward",4,!1,!1);return n&&(i=i.reverse()),i.unshift(i[0]),i.length<5?(v(`No Grand Prix found ${n?"to":"from"} ${t[e].names.en_gb}`),[]):i}function U(t,e,n){const s=n?"backward":"forward",o=6;let i=T(t,e,s,o,!1,!1);return n&&(i=i.reverse()),i.length<o?(v(`No Knockout Tour found ${n?"to":"from"} ${t[e].names.en_gb}`),[]):i}function Z(t,e,n,s,o){const r=s?"backward":"forward",c=n+1;let u=T(t,e,r,c,o,!0);return s&&(u=u.reverse()),u.length<c?(v(`No VS (${n} races) found ${s?"to":"from"} ${t[e].names.en_gb}`),[]):u}function tt(t,e,n){const s=F();if(!s){v("No track selected");return}const o=E();L("Selected track:",s.names.en_gb),L("Selected path mode:",t.value),L('Selected "end with":',e.checked),L("Selected include single-track:",n.checked);const r=(()=>{const c=t.value;if(c==="gp")return Q(o,s.id,e.checked);if(c==="kt")return U(o,s.id,e.checked);if(c.startsWith("vs")){const i=Number(c.replace("vs",""));return Z(o,s.id,i,e.checked,n.checked)}return["How did you get here"]})();v(`Resulting path: ${r}`),J(r),j(r)}function M(t,e){const n=t.startsWith("vs");e.disabled=!n,n||(e.checked=!1)}async function et(){console.log("1.0.1");const e={trackMapStore:document.querySelector("#track-map-store"),selectedTrackStore:document.querySelector("#selected-track-store"),trackIconLayer:document.querySelector(".track-icons-layer"),mapImg:document.querySelector(".base-map"),pathGenControls:document.querySelector(".map-controls"),generateButton:document.querySelector(".generate-button"),pathModeSelect:document.querySelector(".path-options-dropdown"),selectedTrackEndCheck:document.querySelector(".selected-track-end"),includeSingleTrackCheck:document.querySelector(".include-single-track")},n=Object.entries(e).filter(([,p])=>p===null).map(([p])=>p);if(n.length>0){const p=n.length>1?"s":"";console.error(`Missing required DOM element${p}: ${n.join(", ")}`);return}const{trackMapStore:s,trackIconLayer:o,mapImg:r,pathGenControls:c,generateButton:i,pathModeSelect:u,selectedTrackEndCheck:h,includeSingleTrackCheck:g}=e;await H(s),R(),i.addEventListener("click",()=>tt(u,h,g)),M(u.value,g),u.addEventListener("change",()=>M(u.value,g));function a(){z(o,r),Y(c,r),W(r)}function d(){X(o,r),a()}r.complete?d():r.addEventListener("load",d),window.addEventListener("resize",a)}et();
